<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>1234</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" referrerpolicy="no-referrer"></script>
    <style>
        body {
            padding: 0;
            margin :0;
        }

        #res {
            width: 200px;
            height: 100px;
        }
    </style>
</head>
<body>
<img id="img" src="./wallhaven-k71rzd.jpg" width="400" height="300"></img>
<div id="res" ></div>
</body>
<script>
    var imgWrap=document.getElementById('img');
    var res=document.getElementById('res');
    let canvas = null;
    const RGBToHSB = (r, g, b) => {
  r /= 255;
  g /= 255;
  b /= 255;
  const v = Math.max(r, g, b),
    n = v - Math.min(r, g, b);
  const h =
    n === 0 ? 0 : n && v === r ? (g - b) / n : v === g ? 2 + (b - r) / n : 4 + (r - g) / n;
  return [60 * (h < 0 ? h + 6 : h), v && (n / v) * 100, v * 100];
};

    const HSBToRGB = (h, s, b) => {
        s /= 100;
        b /= 100;
        const k = (n) => (n + h / 60) % 6;
        const f = (n) => b * (1 - s * Math.max(0, Math.min(k(n), 4 - k(n), 1)));
        return [255 * f(5), 255 * f(3), 255 * f(1)];
    };

    getImageColor()
    function getImageColor() {
        if (!canvas) {
            canvas = document.createElement('canvas');
        }
        var context = canvas.getContext("2d");
        const img = new Image()
        const imgstr = './wallhaven-o31j7l.png';
        img.src = imgstr
        img.onload = () => {
            img.width = 500;
            img.height = 300;
            imgWrap.src = imgstr
            context.drawImage(img, 0, 0, img.width, img.height);
            // 获取像素数据
            const data = context.getImageData(0, 0, img.width, img.height).data;
            console.log(data)

            const rgbArray = [];
            for (let i = 0; i < data.length; i += 4) {
                rgbArray.push(`${data[i]},${data[i + 1]},${data[i + 2]}`);
            }
            console.log(rgbArray)

            const countColor = _.countBy(rgbArray)

            // 排序
            const sortedCountColor = Object.entries(countColor)
                .sort((a, b) => a[1] <= b[1] ? 1 : -1)
                .reduce((acc, pair) => {
                    acc[pair[0]] = pair[1]
                    return acc
                }, {})

            console.log(Object.keys(sortedCountColor).slice(0,10));
            // 2.前10的颜色换算成HSB
            const hsbColorArr = Object.keys(sortedCountColor).slice(0,10).map(each => RGBToHSB(...each.split(',').map(i => parseInt(i,10))))
            console.log('11', hsbColorArr)
            //3.排除S<10、B<15的颜色
            _.remove(hsbColorArr, (colorArr) => {
                return (colorArr[1] < 10 || colorArr[2] < 15)
            })
            console.log('1',hsbColorArr[0]);
            /*
            4.剩下排序第一的颜色，H不变，
            S<15的，S=15，S>50的，S=50
            B<20的，B=20，B>60的，B=60
            */
            const chooseColor = hsbColorArr[0];
            const normalizedRgb = (r) => {
                if (r<15) return r = 15;
                if (r > 50) return r =50
                return r
            }
            console.log([chooseColor[0]].concat(chooseColor.slice(1).map(normalizedRgb)));
            const color = HSBToRGB(...([chooseColor[0]].concat(chooseColor.slice(1).map(normalizedRgb))));

            res.style.backgroundColor= `rgb(${color[0]}, ${color[1]}, ${color[2]})`
        }
    }

    console.log(RGBToHSB(220,220,220));

</script>
</html>

